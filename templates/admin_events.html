{% extends "layout.html" %}

{% block title %}Manage Events - Admin{% endblock %}

{% block head %}
<!-- SweetAlert2 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
    .event-card {
        border-radius: 1.25rem;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.25s ease;
        border: 1px solid #f1f5f9;
        background: #fff;
    }

    .event-card:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }

    .event-card.active-event {
        border-color: rgba(20, 184, 166, 0.3);
        box-shadow: 0 4px 15px rgba(20, 184, 166, 0.1);
    }

    .event-header {
        padding: 1.25rem 1.5rem;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
    }

    .event-body {
        padding: 0 1.5rem 1.25rem;
    }

    .event-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .event-meta-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.85rem;
        color: #64748b;
    }

    .event-meta-item i {
        font-size: 0.95rem;
    }

    .badge-active {
        background: rgba(20, 184, 166, 0.12);
        color: #0d9488;
        font-weight: 600;
        padding: 0.3em 0.85em;
        border-radius: 999px;
        font-size: 0.78rem;
        white-space: nowrap;
    }

    .badge-inactive {
        background: #f1f5f9;
        color: #94a3b8;
        font-weight: 600;
        padding: 0.3em 0.85em;
        border-radius: 999px;
        font-size: 0.78rem;
        white-space: nowrap;
    }

    .event-actions {
        display: flex;
        gap: 0.5rem;
        padding: 0 1.5rem 1.25rem;
    }

    .btn-toggle {
        background: transparent;
        color: #14b8a6;
        font-weight: 600;
        font-size: 0.8rem;
        padding: 0.4rem 1rem;
        border-radius: 0.75rem;
        border: 2px solid rgba(20, 184, 166, 0.3);
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-toggle:hover {
        background: #14b8a6;
        color: #fff;
        border-color: #14b8a6;
    }

    .btn-toggle.deactivate {
        color: #f59e0b;
        border-color: #fde68a;
    }

    .btn-toggle.deactivate:hover {
        background: #f59e0b;
        color: #fff;
        border-color: #f59e0b;
    }

    .btn-event-delete {
        background: transparent;
        color: #ef4444;
        font-weight: 600;
        font-size: 0.8rem;
        padding: 0.4rem 1rem;
        border-radius: 0.75rem;
        border: 2px solid #fecaca;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-event-delete:hover {
        background: #ef4444;
        color: #fff;
        border-color: #ef4444;
    }

    .btn-event-edit {
        background: transparent;
        color: #a855f7;
        font-weight: 600;
        font-size: 0.8rem;
        padding: 0.4rem 1rem;
        border-radius: 0.75rem;
        border: 2px solid rgba(168, 85, 247, 0.3);
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-event-edit:hover {
        background: #a855f7;
        color: #fff;
        border-color: #a855f7;
    }

    .btn-create-event {
        background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
        color: #fff;
        font-weight: 600;
        padding: 0.6rem 1.5rem;
        border-radius: 1rem;
        border: none;
        cursor: pointer;
        transition: all 0.25s ease;
        box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
        font-size: 0.9rem;
    }

    .btn-create-event:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(168, 85, 247, 0.4);
        filter: brightness(1.08);
    }

    .event-count-badge {
        background: rgba(168, 85, 247, 0.1);
        color: var(--bs-primary);
        font-weight: 700;
        padding: 0.4em 1em;
        border-radius: 999px;
        font-size: 0.85rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #94a3b8;
    }

    .empty-state i {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
        display: block;
    }

    .event-description {
        color: #475569;
        font-size: 0.9rem;
        line-height: 1.5;
        margin-bottom: 1rem;
    }

    /* ── SweetAlert2 Event Form Overrides ── */
    .swal2-popup .ef-group {
        margin-bottom: 1rem;
    }

    .swal2-popup .ef-label {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-weight: 600;
        font-size: 0.82rem;
        color: #334155;
        margin-bottom: 0.4rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .swal2-popup .ef-label i {
        color: #a855f7;
        font-size: 0.9rem;
    }

    .swal2-popup .ef-input,
    .swal2-popup .ef-textarea {
        width: 100%;
        border: 2px solid #e2e8f0;
        border-radius: 0.85rem;
        padding: 0.65rem 1rem;
        font-size: 0.9rem;
        font-family: 'Inter', sans-serif;
        color: #1e293b;
        background: #f8fafc;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        outline: none;
        box-sizing: border-box;
    }

    .swal2-popup .ef-input:focus,
    .swal2-popup .ef-textarea:focus {
        border-color: #a855f7;
        box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.12);
        background: #fff;
    }

    .swal2-popup .ef-input::placeholder,
    .swal2-popup .ef-textarea::placeholder {
        color: #94a3b8;
    }

    .swal2-popup .ef-textarea {
        resize: vertical;
        min-height: 70px;
    }

    .swal2-popup .ef-row {
        display: flex;
        gap: 0.75rem;
    }

    .swal2-popup .ef-row .ef-group {
        flex: 1;
    }

    .swal2-popup .ef-divider {
        height: 1px;
        background: #e2e8f0;
        margin: 1.25rem 0;
    }

    .swal2-popup .ef-toggle {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.85rem 1rem;
        background: linear-gradient(135deg, rgba(20, 184, 166, 0.06), rgba(168, 85, 247, 0.06));
        border-radius: 0.85rem;
        cursor: pointer;
        border: 2px solid transparent;
        transition: border-color 0.2s ease;
    }

    .swal2-popup .ef-toggle:has(input:checked) {
        border-color: rgba(20, 184, 166, 0.3);
    }

    .swal2-popup .ef-toggle input[type="checkbox"] {
        width: 20px;
        height: 20px;
        accent-color: #14b8a6;
        cursor: pointer;
        flex-shrink: 0;
    }

    .swal2-popup .ef-toggle-label {
        font-weight: 600;
        font-size: 0.85rem;
        color: #334155;
    }

    .swal2-popup .ef-toggle-hint {
        font-size: 0.78rem;
        color: #94a3b8;
    }

    .swal2-popup .swal2-html-container {
        padding: 0 0.5rem !important;
        margin: 1rem 0 0 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Header -->
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-2">
            <div>
                <h2 class="fw-bold mb-1">Manage Events</h2>
                <p class="text-muted mb-0">Create, activate, and manage community events</p>
            </div>
            <div class="d-flex align-items-center gap-3">
                <span class="event-count-badge">
                    <i class="bi bi-calendar-event me-1"></i>{{ events_list | length }} events
                </span>
                <button type="button" class="btn-create-event" id="createEventBtn">
                    <i class="bi bi-plus-lg me-1"></i>Create Event
                </button>
            </div>
        </div>
    </div>

    <!-- Events List -->
    <div class="col-12">
        {% if events_list %}
        <div class="row g-3">
            {% for e in events_list %}
            <div class="col-12 col-md-6">
                <div class="event-card {{ 'active-event' if e.is_active else '' }}">
                    <div class="event-header">
                        <div>
                            <h5 class="fw-bold mb-1">{{ e.title }}</h5>
                            {% if e.is_active %}
                                <span class="badge-active"><i class="bi bi-lightning-charge-fill me-1"></i>Active</span>
                            {% else %}
                                <span class="badge-inactive"><i class="bi bi-pause-circle me-1"></i>Inactive</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="event-body">
                        {% if e.description %}
                        <p class="event-description">{{ e.description }}</p>
                        {% endif %}
                        <div class="event-meta">
                            {% if e.location %}
                            <div class="event-meta-item">
                                <i class="bi bi-geo-alt"></i>
                                <span>{{ e.location }}</span>
                            </div>
                            {% endif %}
                            {% if e.start_time %}
                            <div class="event-meta-item">
                                <i class="bi bi-clock"></i>
                                <span>{{ e.start_time[:16].replace('T', ' ') if e.start_time else '' }}</span>
                            </div>
                            {% endif %}
                            <div class="event-meta-item">
                                <i class="bi bi-calendar3"></i>
                                <span>Created {{ e.created_at[:10] if e.created_at else '—' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="event-actions">
                        <button type="button"
                                class="btn-event-edit"
                                data-event-id="{{ e.id }}"
                                data-event-title="{{ e.title }}"
                                data-event-desc="{{ e.description or '' }}"
                                data-event-location="{{ e.location or '' }}"
                                data-event-start="{{ e.start_time[:16] if e.start_time else '' }}"
                                data-event-end="{{ e.end_time[:16] if e.end_time else '' }}"
                                data-event-image="{{ e.image_url or '' }}"
                                data-event-active="{{ 'true' if e.is_active else 'false' }}">
                            <i class="bi bi-pencil me-1"></i>Edit
                        </button>
                        <button type="button"
                                class="btn-toggle {{ 'deactivate' if e.is_active else '' }}"
                                data-action="{{ 'deactivate' if e.is_active else 'activate' }}"
                                data-name="{{ e.title }}"
                                data-url="/admin/events/{{ e.id }}/toggle">
                            <i class="bi bi-{{ 'pause-circle' if e.is_active else 'play-circle' }} me-1"></i>
                            {{ 'Deactivate' if e.is_active else 'Activate' }}
                        </button>
                        <button type="button"
                                class="btn-event-delete"
                                data-action="delete_event"
                                data-name="{{ e.title }}"
                                data-url="/admin/events/{{ e.id }}/delete">
                            <i class="bi bi-trash me-1"></i>Delete
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="card">
            <div class="empty-state">
                <i class="bi bi-calendar-x"></i>
                <p class="mb-1 fw-medium">No events yet</p>
                <p class="mb-0 text-muted small">Click "Create Event" to get started</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Hidden Create Event Form (submitted via JS) -->
<form id="createEventForm" method="post" action="/admin/events/create" style="display:none;">
    <input type="hidden" name="title" id="formTitle">
    <input type="hidden" name="description" id="formDescription">
    <input type="hidden" name="location" id="formLocation">
    <input type="hidden" name="start_time" id="formStartTime">
    <input type="hidden" name="end_time" id="formEndTime">
    <input type="hidden" name="image_url" id="formImageUrl">
    <input type="hidden" name="is_active" id="formIsActive">
</form>

<!-- Hidden Edit Event Form (submitted via JS) -->
<form id="editEventForm" method="post" style="display:none;">
    <input type="hidden" name="title" id="editTitle">
    <input type="hidden" name="description" id="editDescription">
    <input type="hidden" name="location" id="editLocation">
    <input type="hidden" name="start_time" id="editStartTime">
    <input type="hidden" name="end_time" id="editEndTime">
    <input type="hidden" name="image_url" id="editImageUrl">
    <input type="hidden" name="is_active" id="editIsActive">
</form>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
(function () {

    /* ── Shared Form Builder ── */
    function buildFormHtml(vals) {
        vals = vals || {};
        return '<div style="text-align:left;">' +
            '<div class="ef-group">' +
                '<div class="ef-label"><i class="bi bi-type-bold"></i> Title <span style="color:#ef4444">*</span></div>' +
                '<input id="swalTitle" class="ef-input" placeholder="e.g. Open Dev Summit \'26" value="' + (vals.title || '').replace(/"/g, '&quot;') + '">' +
            '</div>' +
            '<div class="ef-group">' +
                '<div class="ef-label"><i class="bi bi-card-text"></i> Description</div>' +
                '<textarea id="swalDesc" class="ef-textarea" placeholder="Brief description of the event..." rows="2">' + (vals.description || '') + '</textarea>' +
            '</div>' +
            '<div class="ef-group">' +
                '<div class="ef-label"><i class="bi bi-geo-alt"></i> Location</div>' +
                '<input id="swalLocation" class="ef-input" placeholder="e.g. Main Auditorium, UoK" value="' + (vals.location || '').replace(/"/g, '&quot;') + '">' +
            '</div>' +
            '<div class="ef-row">' +
                '<div class="ef-group">' +
                    '<div class="ef-label"><i class="bi bi-play-circle"></i> Start</div>' +
                    '<input id="swalStart" type="datetime-local" class="ef-input" value="' + (vals.start_time || '') + '">' +
                '</div>' +
                '<div class="ef-group">' +
                    '<div class="ef-label"><i class="bi bi-stop-circle"></i> End</div>' +
                    '<input id="swalEnd" type="datetime-local" class="ef-input" value="' + (vals.end_time || '') + '">' +
                '</div>' +
            '</div>' +
            '<div class="ef-group">' +
                '<div class="ef-label"><i class="bi bi-image"></i> Cover Image URL</div>' +
                '<input id="swalImage" class="ef-input" placeholder="https://..." value="' + (vals.image_url || '').replace(/"/g, '&quot;') + '">' +
            '</div>' +
            '<div class="ef-divider"></div>' +
            '<label class="ef-toggle">' +
                '<input id="swalActive" type="checkbox"' + (vals.is_active ? ' checked' : '') + '>' +
                '<div>' +
                    '<div class="ef-toggle-label">Set as active event</div>' +
                    '<div class="ef-toggle-hint">Other active events will be deactivated</div>' +
                '</div>' +
            '</label>' +
            '</div>';
    }

    function getFormValues() {
        var title = document.getElementById('swalTitle').value.trim();
        if (!title) { Swal.showValidationMessage('Title is required'); return false; }
        return {
            title: title,
            description: document.getElementById('swalDesc').value.trim(),
            location: document.getElementById('swalLocation').value.trim(),
            start_time: document.getElementById('swalStart').value,
            end_time: document.getElementById('swalEnd').value,
            image_url: document.getElementById('swalImage').value.trim(),
            is_active: document.getElementById('swalActive').checked
        };
    }

    /* ── Create Event Modal ── */
    document.getElementById('createEventBtn').addEventListener('click', function () {
        Swal.fire({
            title: 'Create New Event',
            html: buildFormHtml(),
            showCancelButton: true,
            confirmButtonText: '<i class="bi bi-plus-lg me-1"></i>Create Event',
            confirmButtonColor: '#a855f7',
            cancelButtonColor: '#64748b',
            reverseButtons: true,
            customClass: { popup: 'rounded-4', htmlContainer: 'text-start' },
            width: '520px',
            preConfirm: getFormValues
        }).then(function (result) {
            if (result.isConfirmed) {
                var d = result.value;
                document.getElementById('formTitle').value = d.title;
                document.getElementById('formDescription').value = d.description;
                document.getElementById('formLocation').value = d.location;
                document.getElementById('formStartTime').value = d.start_time;
                document.getElementById('formEndTime').value = d.end_time;
                document.getElementById('formImageUrl').value = d.image_url;
                document.getElementById('formIsActive').value = d.is_active ? 'on' : '';
                document.getElementById('createEventForm').submit();
            }
        });
    });

    /* ── Edit Event Modal ── */
    document.querySelectorAll('.btn-event-edit').forEach(function (btn) {
        btn.addEventListener('click', function () {
            var eventId = btn.dataset.eventId;
            var vals = {
                title: btn.dataset.eventTitle,
                description: btn.dataset.eventDesc,
                location: btn.dataset.eventLocation,
                start_time: btn.dataset.eventStart,
                end_time: btn.dataset.eventEnd,
                image_url: btn.dataset.eventImage,
                is_active: btn.dataset.eventActive === 'true'
            };

            Swal.fire({
                title: 'Edit Event',
                html: buildFormHtml(vals),
                showCancelButton: true,
                confirmButtonText: '<i class="bi bi-check-lg me-1"></i>Save Changes',
                confirmButtonColor: '#a855f7',
                cancelButtonColor: '#64748b',
                reverseButtons: true,
                customClass: { popup: 'rounded-4', htmlContainer: 'text-start' },
                width: '520px',
                preConfirm: getFormValues
            }).then(function (result) {
                if (result.isConfirmed) {
                    var d = result.value;
                    var form = document.getElementById('editEventForm');
                    form.action = '/admin/events/' + eventId + '/edit';
                    document.getElementById('editTitle').value = d.title;
                    document.getElementById('editDescription').value = d.description;
                    document.getElementById('editLocation').value = d.location;
                    document.getElementById('editStartTime').value = d.start_time;
                    document.getElementById('editEndTime').value = d.end_time;
                    document.getElementById('editImageUrl').value = d.image_url;
                    document.getElementById('editIsActive').value = d.is_active ? 'on' : '';
                    form.submit();
                }
            });
        });
    });

    /* ── Confirm Actions (Toggle / Delete) ── */
    function handleAction(btn) {
        var action = btn.dataset.action;
        var name   = btn.dataset.name;
        var url    = btn.dataset.url;

        var config = {
            activate: {
                title: 'Activate Event',
                html: 'Set <strong>' + name + '</strong> as the active event?<br><small class="text-muted">All other events will be deactivated.</small>',
                icon: 'question', iconColor: '#14b8a6',
                confirmButtonText: 'Yes, Activate', confirmButtonColor: '#14b8a6'
            },
            deactivate: {
                title: 'Deactivate Event',
                html: 'Deactivate <strong>' + name + '</strong>?<br><small class="text-muted">No event will be active.</small>',
                icon: 'warning', iconColor: '#f59e0b',
                confirmButtonText: 'Yes, Deactivate', confirmButtonColor: '#f59e0b'
            },
            delete_event: {
                title: 'Delete Event',
                html: 'Delete <strong>' + name + '</strong>?<br><small class="text-muted">This action cannot be undone.</small>',
                icon: 'warning', iconColor: '#ef4444',
                confirmButtonText: 'Yes, Delete', confirmButtonColor: '#ef4444'
            }
        }[action];

        Swal.fire({
            ...config,
            showCancelButton: true,
            cancelButtonText: 'Cancel',
            cancelButtonColor: '#64748b',
            reverseButtons: true,
            customClass: { popup: 'rounded-4' }
        }).then(function (result) {
            if (result.isConfirmed) {
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = url;
                document.body.appendChild(form);
                form.submit();
            }
        });
    }

    document.querySelectorAll('[data-action]').forEach(function (btn) {
        btn.addEventListener('click', function () { handleAction(btn); });
    });

    /* ── Success Toast ── */
    var params  = new URLSearchParams(window.location.search);
    var success = params.get('success');

    if (success) {
        window.history.replaceState({}, '', window.location.pathname);

        var messages = {
            created:       { title: 'Event Created!',      text: 'The new event has been added.' },
            updated:       { title: 'Event Updated!',      text: 'The event has been saved.' },
            activated:     { title: 'Event Activated!',     text: 'This is now the active event.' },
            deactivated:   { title: 'Event Deactivated',    text: 'The event is now inactive.' },
            event_deleted: { title: 'Event Deleted',        text: 'The event has been removed.' }
        };
        var msg = messages[success] || { title: 'Done!', text: '' };

        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: msg.title,
            text: msg.text,
            showConfirmButton: false,
            timer: 4000,
            timerProgressBar: true
        });
    }
})();
</script>
{% endblock %}
